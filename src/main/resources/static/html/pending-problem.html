<!DOCTYPE html>
<html>
<head>
<title>问题上报</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta charset="UTF-8">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="stylesheet" href="../jsPackage/layui-v2.4.2/css/layui.css">
<link rel="stylesheet" href="../css/report.css" media="all">
<body style="background-color: #F0F0F0;">
	<div class="layui-row layui-col-space10">
		<div class="layui-col-md10">
			<table class="layui-table" lay-filter="test" id="pending"></table>
		</div>
	</div>


	<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
	<!--[if lt IE 9]>
	  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
	  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->


	<script type="text/html" id="barDemo">
 		 <a class="layui-btn layui-btn-xs" lay-event="edit">处理</a>
	</script>
	<script src="../jsPackage/js/jquery-1.9.1.min.js"></script>
	<script src="../jsPackage/js/jquery.cookie.js"></script>
	<!-- 引入layui -->
	<script type="text/javascript" src="../jsPackage/layui-v2.4.2/layui.js"></script>
	<script type="text/javascript">
    	//加载layui内置模块
		layui.use(['jquery','table'], function(){
		  var form = layui.form
		  ,table = layui.table
		  ,$ = layui.$; //重点处,使用jQuery
		  window.addEventListener('message', function(e) {
		        var data = JSON.parse(e.data);
		        console.log(data);
		        if (data) {
		        	//需要的基本信息写入cookie
		        	$.cookie('name',data.name);
		        	$.cookie('organ',data.organ);
		        }
		    }, false); 
  		  table.render({
			    elem: '#pending'
			    ,height: 420
			    ,url: '/iot_process/process/tasks/layui' //数据接口
			    ,where:{
			    	"userName":$.cookie("name").replace(/"/g,"")
			    }
		  		,skin:'line'
			    ,cols: [[ //表头
			      {field: 'piid', title: 'ID', hide:true}
			      ,{field: 'area', title: '属地', hide:true}
			      ,{field: 'currentnode', title: '流程节点'}
			      ,{field: 'describle', title: '问题描述'}
			      ,{field: 'reportperson', title: '上报人'}
			      ,{field: 'tip', title: '是否超期'}
			      ,{fixed: 'right', width: 165, align:'center', toolbar: '#barDemo'}
			    ]]
			  });
		  //监听行工具事件
		  table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
		    var data = obj.data //获得当前行数据
		    ,layEvent = obj.event; //获得 lay-event 对应的值
		    if(layEvent === 'edit'){
		    	//根据属地判断跳转页面
		    	var  toHtml={"作业接收":"receive-task.html","作业完成":"finish-task.html","作业验收":"acceptance.html"};
		    	if(data.currentnode=="问题评估"){
			    	switch(data.area){
			    	case "HSE办公室":
			    	case "设备办":
			    	case "生产办":
			    	case "综合办":
			    	case "财务经营办":
			    		html="estimate.html";
			    		break;
			    	case "净化工段":
			    	case "化验":
		    		html="estimate-team-leader.html";
		    		break;
		    		default:
		    			html="estimate-repair.html";
			    	}
		    	}else{
		    		html=toHtml[data.currentnode]
		    	}
				location.href=html+"?piid="+data.piid+"&area="+data.area;
		    }
		  });
})	    
</script>
</body>
</html>
